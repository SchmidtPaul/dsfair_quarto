{
  "hash": "943855992d7a177f4aff83b20870700d",
  "result": {
    "markdown": "---\ntitle: \"Model Diagnostics\"\n---\n\n\n\n\n# What is it?\n\nMost statistical methods and all statistical models make certain assumptions (about the data generating process), and (test) results will be meaningless or misleading if theses assumptions do not hold. Therefore, model diagnostics should be used to check how well the assumptions of any given model are met.\n\n# Which assumptions?\n\nAs an example, we will specifically address the assumptions that ANOVA (analysis of variance) has. It makes sense to choose ANOVA because of its popularity and relevance in the chapters of this website. The following model will serve as an example throughout the chapter:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- lm(weight ~ group, data = PlantGrowth)\n```\n:::\n\n\nNote that both the `PlantGrowth` data and the `lm()` function come with base R and thus don't need any extra imports. In a next step, we would want to run `anova(mod)`. While all of the tests and plots that follow could also be produced with base R, I choose to use other packages here that I personally prefer for convenience and/or functionality reasons.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# (install &) load packages\npacman::p_load(\n  easystats, \n  olsrr,\n  qqplotr, \n  tidyverse\n  )\n```\n:::\n\n\n## Independence\n\n**Assumption: Individual observations are independent of each other (as opposed to dependent/correlated).**\n\nModel diagnostics are actually not used to verify this specific assumption. Instead, this assumption is justified if proper randomization was applied as part of the experimental design. Keep in mind, that there are indeed non-classical scenarios like repeated measures over time or certain experimental designs where observations are not (assumed to be) independent, but these are not covered in this chapter.\n\n## Normality\n\n**Assumption: The errors follow a normal distribution.**\n\nA model's errors cannot be directly observed, but are estimated by their residuals; these residuals can be used for checking normality.\n\n::: callout-important\n## Yes residuals - not data!\n\nUnfortunately, it is more common than it should be that people check whether their raw data (i.e. their response variable, e.g. yield) is normally distributed. This is not constructive. Instead, the model's residuals should be checked for normality. Please see section \"4 \\| ANSWERING QUESTION 1\" in @kozak_2018 for details.\n:::\n\n### QQ plot\n\nApproximate normality can be assumed, if the dots in a QQ plot look close to a straight line. @kozak_2018 point out that *when it comes to checking normality, we need to be clear that we will never be able to check whether indeed the distribution is fully normal; instead, we should check whether it is approximately normal*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod %>% \n  check_normality() %>% \n  plot(type = \"qq\")\n```\n\n::: {.cell-output-display}\n![](modeldiagnostics_files/figure-html/unnamed-chunk-4-1.png){width=1650}\n:::\n:::\n\n\n### Tests\n\nAs explained [further below](modeldiagnostics.qmd#plots-instead-of-tests), I do not embrace using statistical tests to check assumptions, but instead suggest using the diagnostic plot above. However, for completeness I still provide the following information:\n\nThere are multiple statistical tests for detecting a violation of the normality assumption. A p-value \\< 0.05 would suggest such a violation:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nols_test_normality(mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n-----------------------------------------------\n       Test             Statistic       pvalue  \n-----------------------------------------------\nShapiro-Wilk              0.9661         0.4379 \nKolmogorov-Smirnov        0.1101         0.8215 \nCramer-von Mises          3.6109         0.0000 \nAnderson-Darling          0.3582         0.4299 \n-----------------------------------------------\n```\n:::\n:::\n\n\n## Variance homogeneity\n\n**Assumption: The error variance is the same at any set of predictor values.**\n\nAlso referred to as *homoscedasticity* (i.e. the opposite of *heteroscedasticity*)\n\n### Res-Pred Plot\n\nWhile this plot does not seem to have an established name, it always has raw/standardized/studentized residuals on the y axis and fitted/predicted values on the x axis. Variance homogeneity can be assumed if the residuals form an approximate horizontal band around the 0 line indicating homogeneity of error variance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod %>% \n  check_heteroscedasticity() %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](modeldiagnostics_files/figure-html/unnamed-chunk-6-1.png){width=1650}\n:::\n:::\n\n\n### Tests\n\nAs explained [further below](modeldiagnostics.qmd#plots-instead-of-tests), I do not embrace using statistical tests to check assumptions, but instead suggest using the diagnostic plot above. However, for completeness I still provide the following information:\n\nThere are multiple statistical tests for detecting a violation of the variance homogeneity assumption. A p-value \\< 0.05 would suggest such a violation:\n\n::: columns\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nols_test_breusch_pagan(mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n\n Breusch Pagan Test for Heteroskedasticity\n -----------------------------------------\n Ho: the variance is constant            \n Ha: the variance is not constant        \n\n               Data                \n ----------------------------------\n Response : weight \n Variables: fitted values of weight \n\n        Test Summary          \n -----------------------------\n DF            =    1 \n Chi2          =    3.000303 \n Prob > Chi2   =    0.08324896 \n```\n:::\n:::\n\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nols_test_bartlett(\n  data = PlantGrowth, \n  \"weight\", \n  group_var = \"group\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n\n    Bartlett's Test of Homogenity of Variances    \n------------------------------------------------\nHo: Variances are equal across groups\nHa: Variances are unequal for atleast two groups\n\n        Test Summary         \n ----------------------------\n DF            =    2 \n Chi2          =    2.878592 \n Prob > Chi2   =    0.2370946 \n```\n:::\n:::\n\n:::\n:::\n\n## Linearity\n\n**Assumption: The response can be written as a linear combination of the predictors.**\n\nThis assumption can also be checked via the Res-Pred-plot from the *Variance homogeneity* section above. It can assumed to be met if the residuals spread randomly around the 0 line. In other words: At any fitted value, the mean of the residuals should be roughly 0. If this is the case, the linearity assumption is valid. I am not aware of any statistical tests for linearity.\n\n# Plots instead of tests\n\nWhen it comes to diagnosing models, one may separate most approaches into two general categories: **significance tests** and **diagnostic plots**. Personally, I follow @kozak_2018, who show that *\"residual plots are better for checking ANOVA assumptions than statistical tests\"*. Here are two key sections from their publication:\n\n> According to many authors (e.g., Atkinson, 1987; Belsley, Kuh, & Welsch, 2005; Kozak, 2009; Moser & Stevens, 1992; Quinn & Keough, 2002; Rasch, Kubinger, & Moder, 2011; Schucany & Ng, 2006), significance tests should not be used for checking assumptions. Diagnostic residual plots are a better choice. On such diagnostic plots, we can identify untypical observations, heterogeneous within-treatment variances, and lack of normality of the residuals (and thus, of the dependent variable within treatments).\n>\n> \\[...\\]\n>\n> There are two possible reasons for the overuse of statistical tests to check assumptions. First, many researchers base their knowledge on books first published 40 years ago or earlier. Back then, using statistical tests was relatively simple while using diagnostic plots was difficult; thus, these books advised the former, often even not mentioning the latter. Second, most statistical software offers statistical tests for checking assumptions as a default. Using default tests is simple, so users use them. However, we explained why we think that significance tests are not a good way of checking assumptions (in general, not only for ANOVA). First of all, with large samples (a very desirable situation) we risk that even small (and irrelevant) departures from the null hypothesis (which states that the assumption is met) will be detected as significant, and so we would need to reject the hypothesis and state that the assumption is not met. With small samples, the situation is opposite: much larger (and important) departures would not be found significant. Thus, our advice is to use diagnostic plots instead of hypothesis testing to check ANOVA assumptions.\n\n# Problematic cases\n\nYou may encounter situations where the assumptions for Normality, Variance homogeneity and/or Linearity do not seem to be met. Instead of simply not doing any ANOVA, you have two options to proceed: Transforming your data and using generalized linear models.\n\n## Data transformation\n\nTransforming the response variable (e.g. yield) with a mathematical function (e.g. square root) can actually solve your problem. If the diagnostics of a linear model improve noticeably by replacing `yield` with `sqrt(yield)`, you can simply use the latter to conduct an ANOVA and draw conclusions from it. Moreover, you can also compare means via post hoc tests. What follows is an example[^1] where this approach does as intended.\n\n[^1]: This is the same data as in the [latin square chapter](../exan/simple/latsq_bridges1989.qmd).\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\npacman::p_load(agridat,\n               easystats,\n               emmeans,\n               multcomp,\n               multcompView,\n               tidyverse)\n\ndat <- agridat::bridges.cucumber %>%\n  filter(loc == \"Clemson\") %>%\n  mutate(colF = as.factor(col),\n         rowF = as.factor(row))\n```\n:::\n\n\n::: columns\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nmod1 <- lm(\n  yield ~ gen + rowF + colF, \n  data = dat)\n\nmod1 %>% \n  check_normality() %>% \n  plot(type = \"qq\")\n```\n\n::: {.cell-output-display}\n![](modeldiagnostics_files/figure-html/unnamed-chunk-10-1.png){width=1650}\n:::\n:::\n\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\nmod2 <- lm(\n  sqrt(yield) ~ gen + rowF + colF, \n  data = dat)\n\nmod2 %>% \n  check_normality() %>% \n  plot(type = \"qq\")\n```\n\n::: {.cell-output-display}\n![](modeldiagnostics_files/figure-html/unnamed-chunk-11-1.png){width=1650}\n:::\n:::\n\n:::\n:::\n\nYou can see that the QQ plot for `mod2` does indeed look better than that for `mod1`. Thus, we can and should conduct the ANOVA for `mod2`. Its interpretation or rather the conclusions drawn from it are essentially the same - irrespective of whether yield or the square root of yield was modeled: There are significant differences between the genotypes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(mod2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\nAnalysis of Variance Table\n\nResponse: sqrt(yield)\n          Df  Sum Sq Mean Sq F value  Pr(>F)  \ngen        3 10.5123  3.5041  8.8966 0.01256 *\nrowF       3  5.0283  1.6761  4.2555 0.06228 .\ncolF       3  4.2121  1.4040  3.5647 0.08670 .\nResiduals  6  2.3632  0.3939                  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nIt is a little bit different when it comes to mean comparisons via post hoc tests. Not because of the conclusion part - this is the same here, too: e.g. two genotype means may be significantly different from each other according to the Tukey test. However, the mean itself can be irritating, since noone is used to dealing with square roots of yields. However, it is valid to present the means on the backtransformed (= original) scale, as long as it is made clear to the reader that the model fit and mean comparisons were made on a different (= square root) scale.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod2 %>% \n  emmeans(specs = ~ gen, type = \"response\") %>% \n  cld(Letters = letters)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n gen      response   SE df lower.CL upper.CL .group\n Poinsett     20.9 2.87  6     14.4     28.5  a    \n Sprint       25.1 3.14  6     18.0     33.3  a    \n Guardian     30.4 3.46  6     22.5     39.5  ab   \n Dasher       45.3 4.23  6     35.6     56.3   b   \n\nResults are averaged over the levels of: rowF, colF \nConfidence level used: 0.95 \nIntervals are back-transformed from the sqrt scale \nNote: contrasts are still on the sqrt scale \nP value adjustment: tukey method for comparing a family of 4 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n:::\n:::\n\n\nNote that `type = \"response\"` can do the back-transformation for us automatically[^2] and specifically see the part of the message below the mean table that reads \"Intervals are back-transformed from the sqrt scale. Note: contrasts are still on the sqrt scale\".\n\n[^2]: This works only if you did the transformation as part of the model as we did here in `lm()`. It cannot work if you did the transformation by creating a column in the dataset before fitting the model.\n\n## Generalized linear models\n\nTO DO\n\n:::{.callout-tip collapse=\"true\"}\n## Additional Resources\n\n**General**\n\n-   What's normal anyway? Residual plots are more telling than significance tests when checking ANOVA assumptions [@kozak_2018]\n-   [Chapter 13 Model Diagnostics](https://book.stat420.org/model-diagnostics.html) in Applied Statistics with R (Dalpiaz, 2022)\n-   [Chapter 8 Model Diagnostics](https://bookdown.org/marklhc/notes_bookdown/model-diagnostics.html) in Course Handouts for Bayesian Data Analysis (Lai, 2019)\n-   ðŸ‡©ðŸ‡ª [Verbleibende Plots interpretieren, um Ihre Regression zu verbessern](https://www.qualtrics.com/support/de/stats-iq/analyses/regression-guides/interpreting-residual-plots-improve-regression/?rid=langMatch&prevsite=en&newsite=de&geo=DE&geomatch=)\n-   [{olsrr}](https://olsrr.rsquaredacademy.com/)\n\n**Normality**\n\n-   [R Tutorial: Normal Probability Plot of Residuals](www.r-tutor.com/elementary-statistics/simple-linear-regression/normal-probability-plot-residuals)\n-   For this specific purpose, QQ plots may also be called [Normal probability plots](https://www.wikiwand.com/en/Normal_probability_plot)\n-   [{qqplotr}](https://cran.r-project.org/web/packages/qqplotr/vignettes/introduction.html)\n\n**Homoscedasticity**\n\n-   [Documentation on tests from {olsrr}](https://olsrr.rsquaredacademy.com/articles/heteroskedasticity.html)\n-   Wikipedia article on [Homoscedasticity and heteroscedasticity](https://www.wikiwand.com/en/Homoscedasticity%20and%20heteroscedasticity)\n\n**Transformation**\n\n-   ðŸ‡©ðŸ‡ª Chapter 3.3 in @dormann_2011\n:::\n",
    "supporting": [
      "modeldiagnostics_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}