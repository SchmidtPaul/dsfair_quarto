{
  "hash": "a3c0810cae7da9d8f28c4ab51bd3c61a",
  "result": {
    "markdown": "---\ntitle: \"Two-way split-plot design\"\nabstract: \"Two-way ANOVA & pairwise comparison post hoc tests in a split-plot design.\"\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# (install &) load packages\npacman::p_load(\n  conflicted,\n  desplot,\n  emmeans,\n  ggtext,\n  lme4,\n  lmerTest,\n  MetBrewer,\n  multcomp,\n  multcompView,\n  tidyverse)\n\n# handle function conflicts\nconflict_prefer(\"filter\", \"dplyr\") \nconflict_prefer(\"select\", \"dplyr\")\nconflict_prefer(\"lmer\", \"lmerTest\")\n```\n:::\n\n\n# Data\n\nThis dataset was originally published in @gomez_1984 from a yield (kg/ha) trial with 4 genotypes (`G`) and 6 nitrogen levels (`N`), leading to 24 treatment level combinations. The data set here has 3 complete replicates (`rep`) and is laid out as a randomized complete block design (RCBD).\n\n## Import\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# data is available online:\npath <- \"https://raw.githubusercontent.com/SchmidtPaul/dsfair_quarto/master/data/Gomez&Gomez1984.csv\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- read_csv(path) # use path from above\ndat\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 72 × 7\n   yield   row   col rep   mainplot G     N     \n   <dbl> <dbl> <dbl> <chr> <chr>    <chr> <chr> \n 1  4520     4     1 rep1  mp01     Simba Goomba\n 2  5598     2     2 rep1  mp02     Simba Koopa \n 3  6192     1     3 rep1  mp03     Simba Toad  \n 4  8542     2     4 rep1  mp04     Simba Peach \n 5  5806     2     5 rep1  mp05     Simba Diddy \n 6  7470     1     6 rep1  mp06     Simba Yoshi \n 7  4034     2     1 rep1  mp01     Nala  Goomba\n 8  6682     4     2 rep1  mp02     Nala  Koopa \n 9  6869     3     3 rep1  mp03     Nala  Toad  \n10  6318     4     4 rep1  mp04     Nala  Peach \n# ℹ 62 more rows\n```\n:::\n:::\n\n\n## Format\n\nBefore anything, the columns `rep`, `N` and `G` should be encoded as factors, since R by default encoded them as character.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- dat %>%\n  mutate(across(c(rep:N), ~ as.factor(.x)))\n```\n:::\n\n\n## Explore\n\nWe make use of [`dlookr::describe()`](../../misc/usefulthings.qmd#dlookr) to conveniently obtain descriptive summary tables. Here, we get can summarize per nitrogen level, per genotype and also per nitrogen-genotype-combination.\n\n::: columns\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% \n  group_by(N) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean))\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 6 × 5\n  N          n    na  mean    sd\n  <fct>  <int> <int> <dbl> <dbl>\n1 Diddy     12     0 5866.  832.\n2 Toad      12     0 5864. 1434.\n3 Yoshi     12     0 5812  2349.\n4 Peach     12     0 5797. 2660.\n5 Koopa     12     0 5478.  657.\n6 Goomba    12     0 4054.  672.\n```\n:::\n\n```{.r .cell-code}\ndat %>% \n  group_by(G) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean))\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 4 × 5\n  G         n    na  mean    sd\n  <fct> <int> <int> <dbl> <dbl>\n1 Simba    18     0 6554. 1475.\n2 Nala     18     0 6156. 1078.\n3 Timon    18     0 5563. 1269.\n4 Pumba    18     0 3642. 1434.\n```\n:::\n:::\n\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% \n  group_by(N, G) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean)) %>% \n  print(n=Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 24 × 6\n   N      G         n    na  mean     sd\n   <fct>  <fct> <int> <int> <dbl>  <dbl>\n 1 Peach  Simba     3     0 8701.  270. \n 2 Yoshi  Simba     3     0 7563.   86.9\n 3 Yoshi  Nala      3     0 6951.  808. \n 4 Toad   Nala      3     0 6895   166. \n 5 Toad   Simba     3     0 6733.  490. \n 6 Yoshi  Timon     3     0 6687.  496. \n 7 Peach  Nala      3     0 6540.  936. \n 8 Diddy  Simba     3     0 6400   523. \n 9 Diddy  Nala      3     0 6259   499. \n10 Peach  Timon     3     0 6065. 1097. \n11 Toad   Timon     3     0 6014   515. \n12 Diddy  Timon     3     0 5994   101. \n13 Koopa  Nala      3     0 5982   684. \n14 Koopa  Simba     3     0 5672   458. \n15 Koopa  Timon     3     0 5443.  589. \n16 Koopa  Pumba     3     0 4816   506. \n17 Diddy  Pumba     3     0 4812   963. \n18 Goomba Pumba     3     0 4481.  463. \n19 Goomba Nala      3     0 4306   646. \n20 Goomba Simba     3     0 4253.  248. \n21 Toad   Pumba     3     0 3816  1311. \n22 Goomba Timon     3     0 3177.  453. \n23 Yoshi  Pumba     3     0 2047.  703. \n24 Peach  Pumba     3     0 1881.  407. \n```\n:::\n:::\n\n:::\n:::\n\nAdditionally, we can decide to plot our data. One way to deal with the combination of two factors would be to use [panels/facets in ggplot2](https://ggplot2.tidyverse.org/reference/facet_grid.html).\n\nNote that we here define a custom set of colors for the Nitrogen levels that will be used throughout this chapter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNcolors <- met.brewer(\"VanGogh2\", 6) %>% \n  as.vector() %>% \n  set_names(levels(dat$N))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(data = dat) +\n  aes(y = yield, x = N, color = N) +\n  facet_wrap(~G, labeller = label_both) +\n  stat_summary(\n    fun = mean,\n    colour = \"grey\",\n    geom = \"line\",\n    linetype = \"dotted\",\n    group = 1\n  ) +\n  geom_point() +\n  scale_x_discrete(\n    name = \"Nitrogen\"\n  ) +\n  scale_y_continuous(\n    name = \"Yield\",\n    limits = c(0, NA),\n    expand = expansion(mult = c(0, 0.1))\n  ) +\n  scale_color_manual(\n    values = Ncolors, \n    guide = \"none\"\n  ) +\n  theme_bw() +\n  theme(axis.text.x = element_text(\n    angle = 45,\n    hjust = 1,\n    vjust = 1\n  ))\n```\n\n::: {.cell-output-display}\n![](splitplot_gomezgomez1984_files/figure-html/unnamed-chunk-9-1.png){width=1650}\n:::\n:::\n\n\nFinally, since this is an experiment that was laid with a certain experimental design (= a split-plot design) - it makes sense to also get a field plan. This can be done via `desplot()` from [{desplot}](../../misc/usefulthings.qmd#desplot).\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndesplot(\n  data = dat,\n  form = rep ~ col + row | rep, # fill color per rep, headers per rep\n  col.regions = c(\"white\", \"grey95\", \"grey90\"),\n  text = G, # genotype names per plot\n  cex = 0.8, # genotype names: font size\n  shorten = \"abb\", # genotype names: abbreviate\n  col = N, # color of genotype names for each N-level\n  col.text = Ncolors, # use custom colors from above\n  out1 = col, out1.gpar = list(col = \"darkgrey\"), # lines between columns\n  out2 = row, out2.gpar = list(col = \"darkgrey\"), # lines between rows\n  main = \"Field layout\", # plot title\n  show.key = TRUE, # show legend\n  key.cex = 0.7 # legend font size\n  )\n```\n\n::: {.cell-output-display}\n![](splitplot_gomezgomez1984_files/figure-html/unnamed-chunk-10-1.png){width=1650}\n:::\n:::\n\n\n::: columns\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndesplot(\n  data = dat,\n  form = yield ~ col + row | rep, # fill color per rep, headers per rep\n  text = G, # genotype names per plot\n  cex = 0.8, # genotype names: font size\n  shorten = \"abb\", # genotype names: abbreviate\n  col  = N, # color of genotype names for each N-level\n  col.text = Ncolors, # use custom colors from above\n  out1 = col, out1.gpar = list(col = \"darkgrey\"), # lines between columns\n  out2 = row, out2.gpar = list(col = \"darkgrey\"), # lines between rows\n  main = \"Yield per plot\", # plot title\n  show.key = FALSE # show legend\n  )\n```\n\n::: {.cell-output-display}\n![](splitplot_gomezgomez1984_files/figure-html/unnamed-chunk-11-1.png){width=1650}\n:::\n:::\n\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"49%\"}\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nmainplotcolors <- c(met.brewer(\"VanGogh3\", 6),\n                    met.brewer(\"Hokusai2\", 6),\n                    met.brewer(\"OKeeffe2\", 6)) %>%\n  as.vector() %>%\n  set_names(levels(dat$mainplot))\n\ndesplot(\n  data = dat,\n  form = mainplot ~ col + row | rep, # fill color per rep, headers per rep\n  col.regions = mainplotcolors,\n  out1 = col, out1.gpar = list(col = \"darkgrey\"), # lines between columns\n  out2 = row, out2.gpar = list(col = \"darkgrey\"), # lines between rows\n  main = \"Experimental design focus\", # plot title\n  show.key = TRUE, # don't show legend\n  key.cex = 0.6\n  )\n```\n\n::: {.cell-output-display}\n![](splitplot_gomezgomez1984_files/figure-html/unnamed-chunk-12-1.png){width=1650}\n:::\n:::\n\n:::\n:::\n\n# Model\n\nFinally, we can decide to fit a linear model with yield as the response variable. In this example it makes sense to mentally group the effects in our model as either *design effects* or *treatment effects*. The treatments here are the genotypes `G` and the nitrogen levels `N` which we will include in the model as main effects, but also via their interaction effect `N:G`. Regarding the design, the model needs to contain a block (`rep`) effect representing the three complete blocks. Additionally, there should also be random effects for the 18 mainplots, since they represent additional randomization units.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- lmer(yield ~ G + N + G:N +\n              rep + (1 | rep:mainplot),\n            data = dat)\n```\n:::\n\n\n:::{.callout-warning collapse=\"true\"}\n## Model assumptions met? (click to show)\n\nIt would be at this moment (i.e. after fitting the model and before running the ANOVA), that you should check whether the model assumptions are met. Find out more in the [summary article \"Model Diagnostics\"](../../summaryarticles/modeldiagnostics.qmd)\n:::\n\n# ANOVA\n\nBased on our model, we can then conduct an ANOVA:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nANOVA <- anova(mod)\nANOVA\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\nType III Analysis of Variance Table with Satterthwaite's method\n      Sum Sq  Mean Sq NumDF DenDF F value    Pr(>F)    \nG   89885051 29961684     3    36 85.7416 < 2.2e-16 ***\nN   19192886  3838577     5    10 10.9849 0.0008277 ***\nrep   683088   341544     2    10  0.9774 0.4095330    \nG:N 69378044  4625203    15    36 13.2360 2.078e-10 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nAccordingly, the ANOVA's F-test found the nitrogen-genotype-interaction to be statistically different (p < .001***).\n\n# Mean comparison\n\nBesides an ANOVA, one may also want to compare adjusted yield means between cultivars via post hoc tests (t-test, Tukey test etc.). Especially because of the results of this ANOVA, we should compare means for all `N:G` interactions and **not** for the `N` and/or `G` main effects. When doing so, we still have multiple options to choose from. I here decide to compare all genotype means per nitrogen\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_comp <- mod %>% \n  emmeans(specs = ~ N|G) %>% # adj. mean per cultivar\n  cld(Letters = letters) # compact letter display (CLD)\n\nmean_comp\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\nG = Nala:\n N      emmean  SE   df lower.CL upper.CL .group\n Goomba   4306 366 41.9     3568     5044  a    \n Koopa    5982 366 41.9     5244     6720   b   \n Diddy    6259 366 41.9     5521     6997   b   \n Peach    6540 366 41.9     5803     7278   b   \n Toad     6895 366 41.9     6157     7633   b   \n Yoshi    6951 366 41.9     6213     7688   b   \n\nG = Pumba:\n N      emmean  SE   df lower.CL upper.CL .group\n Peach    1881 366 41.9     1143     2618  a    \n Yoshi    2047 366 41.9     1309     2784  a    \n Toad     3816 366 41.9     3078     4554   b   \n Goomba   4481 366 41.9     3744     5219   b   \n Diddy    4812 366 41.9     4074     5550   b   \n Koopa    4816 366 41.9     4078     5554   b   \n\nG = Simba:\n N      emmean  SE   df lower.CL upper.CL .group\n Goomba   4253 366 41.9     3515     4990  a    \n Koopa    5672 366 41.9     4934     6410  ab   \n Diddy    6400 366 41.9     5662     7138   bc  \n Toad     6733 366 41.9     5995     7470   bc  \n Yoshi    7563 366 41.9     6826     8301    cd \n Peach    8701 366 41.9     7963     9438     d \n\nG = Timon:\n N      emmean  SE   df lower.CL upper.CL .group\n Goomba   3177 366 41.9     2440     3915  a    \n Koopa    5443 366 41.9     4705     6180   b   \n Diddy    5994 366 41.9     5256     6732   b   \n Toad     6014 366 41.9     5276     6752   b   \n Peach    6065 366 41.9     5328     6803   b   \n Yoshi    6687 366 41.9     5950     7425   b   \n\nResults are averaged over the levels of: rep \nDegrees-of-freedom method: kenward-roger \nConfidence level used: 0.95 \nP value adjustment: tukey method for comparing a family of 6 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping symbol,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n:::\n:::\n\n\nNote that if you would like to see the underlying individual contrasts/differences between adjusted means, simply add `details = TRUE` to the `cld()` statement. Furthermore, check out the [Summary Article \"Compact Letter Display\"](../../summaryarticles/compactletterdisplay.qmd).\n\nFinally, we can create a plot that displays both the raw data and the results, *i.e.* the comparisons of the adjusted means that are based on the linear model.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nmy_caption <- \"The four facettes represent genotypes Simba, Nala, Timon and Pumba. Black dots represent raw data. Red dots and error bars represent adjusted means with 95% confidence limits per cultivar. For each genotype separately, means followed by a common letter are not significantly different according to the Tukey-test.\"\n\nggplot() +\n  facet_wrap(~G, labeller = label_both) + # facette per G level\n  aes(x = N) +\n  # black dots representing the raw data\n  geom_point(\n    data = dat,\n    aes(y = yield, color = N)\n  ) +\n  # red dots representing the adjusted means\n  geom_point(\n    data = mean_comp,\n    aes(y = emmean),\n    color = \"red\",\n    position = position_nudge(x = 0.2)\n  ) +\n  # red error bars representing the confidence limits of the adjusted means\n  geom_errorbar(\n    data = mean_comp,\n    aes(ymin = lower.CL, ymax = upper.CL),\n    color = \"red\",\n    width = 0.1,\n    position = position_nudge(x = 0.2)\n  ) +\n  # red letters \n  geom_text(\n    data = mean_comp,\n    aes(y = emmean, label = str_trim(.group)),\n    color = \"red\",\n    position = position_nudge(x = 0.35),\n    hjust = 0\n  ) +\n  scale_x_discrete(\n    name = \"Nitrogen\"\n  ) +\n  scale_y_continuous(\n    name = \"Yield\",\n    limits = c(0, NA),\n    expand = expansion(mult = c(0, 0.1))\n  ) +\n  scale_color_manual(\n    values = Ncolors, \n    guide = \"none\"\n  ) +\n  theme_bw() +\n  labs(caption = my_caption) +\n  theme(\n    plot.caption = element_textbox_simple(margin = margin(t = 5)),\n    plot.caption.position = \"plot\",\n    axis.text.x = element_text(\n      angle = 45,\n      hjust = 1,\n      vjust = 1\n    )\n  )\n```\n\n::: {.cell-output-display}\n![](splitplot_gomezgomez1984_files/figure-html/unnamed-chunk-16-1.png){width=1650}\n:::\n:::\n",
    "supporting": [
      "splitplot_gomezgomez1984_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}