{
  "hash": "c3142a59f133765f0cbd4a1669b822d7",
  "result": {
    "markdown": "---\ntitle: \"Two-way randomized complete block design\"\ndate: 2022-11-20\nabstract: \"Two-way ANOVA & pairwise comparison post hoc tests in a randomized complete block design.\"\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# (install &) load packages\npacman::p_load(\n  conflicted,\n  desplot,\n  emmeans,\n  ggtext,\n  MetBrewer,\n  multcomp,\n  multcompView,\n  tidyverse)\n\n# handle function conflicts\nconflict_prefer(\"filter\", \"dplyr\") \nconflict_prefer(\"select\", \"dplyr\")\n```\n:::\n\n\n\n# Data\n\nThis data is a slightly modified version of a dataset originally published in Gomez & Gomez [-@gomez1984] from a yield (kg/ha) trial with 4 genotypes (`G`) and 6 nitrogen levels (`N`), leading to 24 treatment level combinations. The data set here has 3 complete replicates (`rep`) and is laid out as a randomized complete block design (RCBD).\n\n## Import\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# data is available online:\npath <- \"https://raw.githubusercontent.com/SchmidtPaul/dsfair_quarto/master/data/riceRCBD.csv\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- read_csv(path) # use path from above\ndat\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 72 x 6\n     row   col rep   N     G     yield\n   <dbl> <dbl> <chr> <chr> <chr> <dbl>\n 1     2     6 rep1  N1    A      4520\n 2     3     4 rep1  N2    A      5598\n 3     2     3 rep1  N4    A      6192\n 4     1     1 rep1  N6    A      8542\n 5     2     1 rep1  N3    A      5806\n 6     3     1 rep1  N5    A      7470\n 7     4     5 rep1  N1    B      4034\n 8     4     1 rep1  N2    B      6682\n 9     3     2 rep1  N4    B      6869\n10     1     2 rep1  N6    B      6318\n# ... with 62 more rows\n```\n:::\n:::\n\n\n\n## Format\n\nBefore anything, the columns `rep`, `N` and `G` should be encoded as factors, since R by default encoded them as character.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat <- dat %>%\n  mutate(across(c(rep, N, G), ~ as.factor(.x)))\n```\n:::\n\n\n\n## Explore\n\nWe make use of [`dlookr::describe()`](../../summaryarticles/usefulthings.qmd#dlookr) to conveniently obtain descriptive summary tables. Here, we get can summarize per nitrogen level, per genotype and also per nitrogen-genotype-combination.\n\n::: columns\n::: {.column width=\"49%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% \n  group_by(N) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean))\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 6 x 5\n  N         n    na  mean    sd\n  <fct> <int> <int> <dbl> <dbl>\n1 N3       12     0 5866.  832.\n2 N4       12     0 5864. 1434.\n3 N5       12     0 5812  2349.\n4 N6       12     0 5797. 2660.\n5 N2       12     0 5478.  657.\n6 N1       12     0 4054.  672.\n```\n:::\n\n```{.r .cell-code}\ndat %>% \n  group_by(G) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean))\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 4 x 5\n  G         n    na  mean    sd\n  <fct> <int> <int> <dbl> <dbl>\n1 A        18     0 6554. 1475.\n2 B        18     0 6156. 1078.\n3 C        18     0 5563. 1269.\n4 D        18     0 3642. 1434.\n```\n:::\n:::\n\n\n:::\n\n::: {.column width=\"2%\"}\n:::\n\n::: {.column width=\"49%\"}\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat %>% \n  group_by(N, G) %>% \n  dlookr::describe(yield) %>% \n  select(2:sd) %>%\n  arrange(desc(mean)) %>% \n  print(n=Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\n# A tibble: 24 x 6\n   N     G         n    na  mean     sd\n   <fct> <fct> <int> <int> <dbl>  <dbl>\n 1 N6    A         3     0 8701.  270. \n 2 N5    A         3     0 7563.   86.9\n 3 N5    B         3     0 6951.  808. \n 4 N4    B         3     0 6895   166. \n 5 N4    A         3     0 6733.  490. \n 6 N5    C         3     0 6687.  496. \n 7 N6    B         3     0 6540.  936. \n 8 N3    A         3     0 6400   523. \n 9 N3    B         3     0 6259   499. \n10 N6    C         3     0 6065. 1097. \n11 N4    C         3     0 6014   515. \n12 N3    C         3     0 5994   101. \n13 N2    B         3     0 5982   684. \n14 N2    A         3     0 5672   458. \n15 N2    C         3     0 5443.  589. \n16 N2    D         3     0 4816   506. \n17 N3    D         3     0 4812   963. \n18 N1    D         3     0 4481.  463. \n19 N1    B         3     0 4306   646. \n20 N1    A         3     0 4253.  248. \n21 N4    D         3     0 3816  1311. \n22 N1    C         3     0 3177.  453. \n23 N5    D         3     0 2047.  703. \n24 N6    D         3     0 1881.  407. \n```\n:::\n:::\n\n\n:::\n:::\n\nAdditionally, we can decide to plot our data. One way to deal with the combination of two factors would be to use [panels/facets in ggplot2](https://ggplot2.tidyverse.org/reference/facet_grid.html).\n\nNote that we here define a custom set of colors for the Nitrogen levels that will be used throughout this chapter.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNcolors <- met.brewer(\"VanGogh2\", 6) %>% \n  as.vector() %>% \n  set_names(levels(dat$N))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(data = dat) +\n  aes(y = yield, x = N, color = N) +\n  facet_wrap(~G, labeller = label_both) +\n  stat_summary(\n    fun = mean,\n    colour = \"grey\",\n    geom = \"line\",\n    linetype = \"dotted\",\n    group = 1\n  ) +\n  geom_point() +\n    scale_x_discrete(\n    name = \"Cultivar\"\n  ) +\n  scale_y_continuous(\n    name = \"Yield\",\n    limits = c(0, NA),\n    expand = expansion(mult = c(0, 0.1))\n  ) +\n  scale_color_manual(\n    values = Ncolors, \n    guide = \"none\"\n  ) +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](rcbd_gomezgomez1984_files/figure-pdf/unnamed-chunk-9-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nFinally, since this is an experiment that was laid with a certain experimental design (= a randomized complete block design; RCBD) - it makes sense to also get a field plan. This can be done via `desplot()` from [{desplot}](../../summaryarticles/usefulthings.qmd#desplot).\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndesplot(data = dat,\n        form = rep ~ col + row | rep, # fill color per rep, headers per rep\n        col.regions = c(\"white\", \"grey95\", \"grey90\"),\n        text = G, # genotype names per plot\n        cex = 1, # genotype names: font size\n        shorten = FALSE, # genotype names: don't abbreviate\n        col  = N, # color of genotype names for each N-level\n        col.text = Ncolors, # use custom colors from above\n        out1 = col, out1.gpar = list(col = \"darkgrey\"), # lines between columns\n        out2 = row, out2.gpar = list(col = \"darkgrey\"), # lines between rows\n        main = \"Field layout\", # plot title\n        show.key = TRUE, # show legend\n        key.cex = 0.7 # legend font size\n        )\n```\n\n::: {.cell-output-display}\n![](rcbd_gomezgomez1984_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n# Model\n\nFinally, we can decide to fit a linear model with yield as the response variable. In this example it makes sense to mentally group the effects in our model as either *design effects* or *treatment effects*. The treatments here are the genotypes `G` and the nitrogen levels `N` which we will include in the model as main effects, but also via their interaction effect `N:G`. Regarding the design, the model needs to contain a block (`rep`) effect.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- lm(\n  yield ~ N + G + N:G + rep,\n  data = dat\n)\n```\n:::\n\n\n\n::: custom-callout-modass\nIt would be at this moment (i.e. after fitting the model and before running the ANOVA), that you should check whether the model assumptions are met. Find out more in the [summary article \"Model Diagnostics\"](../../summaryarticles/modeldiagnostics.qmd)\n:::\n\n# ANOVA\n\nBased on our model, we can then conduct an ANOVA:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nANOVA <- anova(mod)\nANOVA\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\nAnalysis of Variance Table\n\nResponse: yield\n          Df   Sum Sq  Mean Sq F value    Pr(>F)    \nN          5 30480453  6096091 15.4677 6.509e-09 ***\nG          3 89885035 29961678 76.0221 < 2.2e-16 ***\nrep        2  1084820   542410  1.3763    0.2627    \nN:G       15 69378044  4625203 11.7356 4.472e-11 ***\nResiduals 46 18129432   394118                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n\nAccordingly, the ANOVA's F-test found the nitrogen-genotype-interaction to be statistically different (p < .001***). \n\n# Mean comparison\n\nBesides an ANOVA, one may also want to compare adjusted yield means between cultivars via post hoc tests (t-test, Tukey test etc.). Especially because of the results of this ANOVA, we should compare means for all `N:G` interactions and **not** for the `N` and/or `G` main effects. When doing so, we still have multiple options to choose from. I here decide to compare all genotype means per nitrogen\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_comp <- mod %>% \n  emmeans(specs = ~ N|G) %>% # adj. mean per cultivar\n  cld(Letters = letters) # compact letter display (CLD)\n\nmean_comp\n```\n\n::: {.cell-output .cell-output-stdout}\n```{.custom-output}\nG = A:\n N  emmean  SE df lower.CL upper.CL .group\n N1   4253 362 46     3523     4982  a    \n N2   5672 362 46     4942     6402  ab   \n N3   6400 362 46     5670     7130   bc  \n N4   6733 362 46     6003     7462   bc  \n N5   7563 362 46     6834     8293    cd \n N6   8701 362 46     7971     9430     d \n\nG = B:\n N  emmean  SE df lower.CL upper.CL .group\n N1   4306 362 46     3576     5036  a    \n N2   5982 362 46     5252     6712   b   \n N3   6259 362 46     5529     6989   b   \n N6   6540 362 46     5811     7270   b   \n N4   6895 362 46     6165     7625   b   \n N5   6951 362 46     6221     7680   b   \n\nG = C:\n N  emmean  SE df lower.CL upper.CL .group\n N1   3177 362 46     2448     3907  a    \n N2   5443 362 46     4713     6172   b   \n N3   5994 362 46     5264     6724   b   \n N4   6014 362 46     5284     6744   b   \n N6   6065 362 46     5336     6795   b   \n N5   6687 362 46     5958     7417   b   \n\nG = D:\n N  emmean  SE df lower.CL upper.CL .group\n N6   1881 362 46     1151     2610  a    \n N5   2047 362 46     1317     2776  a    \n N4   3816 362 46     3086     4546   b   \n N1   4481 362 46     3752     5211   b   \n N3   4812 362 46     4082     5542   b   \n N2   4816 362 46     4086     5546   b   \n\nResults are averaged over the levels of: rep \nConfidence level used: 0.95 \nP value adjustment: tukey method for comparing a family of 6 estimates \nsignificance level used: alpha = 0.05 \nNOTE: If two or more means share the same grouping letter,\n      then we cannot show them to be different.\n      But we also did not show them to be the same. \n```\n:::\n:::\n\n\n\nNote that if you would like to see the underlying individual contrasts/differences between adjusted means, simply add `details = TRUE` to the `cld()` statement. Furthermore, check out the [Summary Article \"Compact Letter Display\"](../../summaryarticles/compactletterdisplay.qmd).\n\nFinally, we can create a plot that displays both the raw data and the results, *i.e.* the comparisons of the adjusted means that are based on the linear model.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nmy_caption <- \"The four facettes represent genotypes A, B, C and D. Black dots represent raw data. Red dots and error bars represent adjusted means with 95% confidence limits per cultivar. For each genotype separately, means followed by a common letter are not significantly different according to the Tukey-test.\"\n\nggplot() +\n  facet_wrap(~G, labeller = label_both) + # facette per G level\n  aes(x = N) +\n  # black dots representing the raw data\n  geom_point(\n    data = dat,\n    aes(y = yield, color = N)\n  ) +\n  # red dots representing the adjusted means\n  geom_point(\n    data = mean_comp,\n    aes(y = emmean),\n    color = \"red\",\n    position = position_nudge(x = 0.2)\n  ) +\n  # red error bars representing the confidence limits of the adjusted means\n  geom_errorbar(\n    data = mean_comp,\n    aes(ymin = lower.CL, ymax = upper.CL),\n    color = \"red\",\n    width = 0.1,\n    position = position_nudge(x = 0.2)\n  ) +\n  # red letters \n  geom_text(\n    data = mean_comp,\n    aes(y = emmean, label = str_trim(.group)),\n    color = \"red\",\n    position = position_nudge(x = 0.35),\n    hjust = 0\n  ) +\n  scale_x_discrete(\n    name = \"Cultivar\"\n  ) +\n  scale_y_continuous(\n    name = \"Yield\",\n    limits = c(0, NA),\n    expand = expansion(mult = c(0, 0.1))\n  ) +\n  scale_color_manual(\n    values = Ncolors, \n    guide = \"none\"\n  ) +\n  theme_bw() +\n  labs(caption = my_caption) +\n  theme(plot.caption = element_textbox_simple(margin = margin(t = 5)),\n        plot.caption.position = \"plot\")\n```\n\n::: {.cell-output-display}\n![](rcbd_gomezgomez1984_files/figure-pdf/unnamed-chunk-14-1.pdf){fig-pos='H'}\n:::\n:::\n",
    "supporting": [
      "rcbd_gomezgomez1984_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{booktabs}\r\n\\usepackage{longtable}\r\n\\usepackage{array}\r\n\\usepackage{multirow}\r\n\\usepackage{wrapfig}\r\n\\usepackage{float}\r\n\\usepackage{colortbl}\r\n\\usepackage{pdflscape}\r\n\\usepackage{tabu}\r\n\\usepackage{threeparttable}\r\n\\usepackage{threeparttablex}\r\n\\usepackage[normalem]{ulem}\r\n\\usepackage{makecell}\r\n\\usepackage{xcolor}\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}